# アプリ統合計画：unified_app.py

## 目的

`main.py` (ファイル文字起こし) と `monitor_app.py` (フォルダ監視) を1つの統合アプリケーションに統合する。

## 現状分析

### main.py (ファイル文字起こしアプリ)
- **機能**:
  - 単一ファイル処理
  - バッチ処理（複数ファイル）
  - 設定: 話者分離、フィラー削除、LLM補正など
- **UI**: QMainWindow、シンプルなレイアウト
- **システムトレイ**: なし
- **ウィンドウサイズ**: 可変（最小400x300）

### monitor_app.py (フォルダ監視アプリ)
- **機能**:
  - フォルダ監視（自動文字起こし）
  - システムトレイ常駐
  - 自動起動設定
  - 完了ファイル自動移動
- **UI**: QMainWindow、コンパクトなレイアウト
- **システムトレイ**: あり（必須）
- **ウィンドウサイズ**: 固定的（350x500）

### 共通コンポーネント
- `workers.py` - TranscriptionWorker, BatchTranscriptionWorker
- `transcription_engine.py` - Kotoba-Whisper エンジン
- `text_formatter.py` - テキスト整形
- `app_settings.py` / `config_manager.py` - 設定管理

## 統合アプリの設計

### UI構造：QTabWidget

```
┌─────────────────────────────────────────────────┐
│ KotobaTranscriber v2.2          [_][□][×]      │ ← タイトルバー + アイコン
├─────────────────────────────────────────────────┤
│ [ ファイル ] [ フォルダ監視 ] [ 設定 ]         │ ← タブバー
├─────────────────────────────────────────────────┤
│                                                 │
│  【タブ内容エリア】                             │
│                                                 │
│  ・ファイルタブ: main.pyの内容                  │
│  ・フォルダ監視タブ: monitor_app.pyの内容       │
│  ・設定タブ: 共通設定                           │
│                                                 │
│                                                 │
│                                                 │
│                                                 │
│                                                 │
│                                                 │
│                                                 │
└─────────────────────────────────────────────────┘
```

### タブ1: ファイル文字起こし

**内容**: main.pyのUIをそのまま移植

- ファイル選択ボタン
- バッチ処理ボタン
- 選択ファイル表示
- バッチファイルリスト
- 処理オプション（話者分離、フィラー削除など）
- プログレスバー
- 文字起こし開始ボタン

**実装**: `FileTranscriptionTab` クラス

### タブ2: フォルダ監視

**内容**: monitor_app.pyのUIをそのまま移植

- フォルダ選択
- 監視開始/停止ボタン
- 監視間隔設定
- 完了フォルダ設定
- 自動移動オプション
- 処理状況表示
- ログ表示（オプション）

**実装**: `FolderMonitorTab` クラス

### タブ3: 設定

**内容**: 共通設定を集約

- **モデル設定**:
  - Whisperモデル選択
  - デバイス選択 (CPU/GPU)

- **処理オプション**:
  - 話者分離
  - フィラー削除
  - LLM補正
  - 音声前処理

- **UI設定**:
  - ダークモード
  - 言語選択
  - 通知設定

- **自動起動設定**:
  - Windows起動時に自動起動
  - 起動時にフォルダ監視開始

**実装**: `SettingsTab` クラス

### システムトレイ

**機能**:
- 常時表示（最小化してもバックグラウンド実行）
- トレイメニュー:
  - 「ウィンドウを表示」
  - 「フォルダ監視開始/停止」
  - 「設定」
  - 「終了」
- 通知:
  - ファイル処理完了
  - フォルダ監視開始
  - エラー通知

**実装**: 既存の `monitor_app.py` のトレイコードを移植

## ファイル構成

### 新規作成ファイル

```
src/unified_app.py              # メインアプリケーション
src/tabs/
    __init__.py
    file_tab.py                 # ファイル処理タブ
    monitor_tab.py              # フォルダ監視タブ
    settings_tab.py             # 設定タブ
```

### 既存ファイルの利用

- `workers.py` - そのまま使用
- `transcription_engine.py` - そのまま使用
- `text_formatter.py` - そのまま使用
- `folder_monitor.py` - そのまま使用
- `app_settings.py` - 拡張（統合設定サポート）
- `dark_theme.py` - そのまま使用

### レガシーファイルの扱い

`main.py` と `monitor_app.py` は後方互換性のため残す（deprecated扱い）

## 実装タスク

### Task 1: 基本構造の作成
**ファイル**: `src/unified_app.py`

- QMainWindow + QTabWidget
- アイコン設定
- システムトレイ初期化
- ウィンドウサイズ・位置の保存/復元

### Task 2: ファイル処理タブの実装
**ファイル**: `src/tabs/file_tab.py`

- main.pyのUIコンポーネントを移植
- TranscriptionWorker / BatchTranscriptionWorker 連携
- 設定の読み込み/保存

### Task 3: フォルダ監視タブの実装
**ファイル**: `src/tabs/monitor_tab.py`

- monitor_app.pyのUIコンポーネントを移植
- FolderMonitor 連携
- 監視状態の管理

### Task 4: 設定タブの実装
**ファイル**: `src/tabs/settings_tab.py`

- 共通設定UI
- app_settings.py との連携
- 設定変更の即座反映

### Task 5: システムトレイ統合
**ファイル**: `src/unified_app.py`

- QSystemTrayIcon 実装
- トレイメニュー
- 通知機能
- ウィンドウ最小化/復元

### Task 6: 設定管理の統合
**ファイル**: `src/app_settings.py` (拡張)

- 統合設定クラス `UnifiedAppSettings`
- ウィンドウ状態（サイズ、位置、選択タブ）
- 各タブの個別設定

### Task 7: テストとデバッグ

- 各タブの動作確認
- タブ切り替え時の状態保持
- システムトレイの動作確認
- 設定の保存/復元

### Task 8: ビルド設定の更新

- `build.spec` に `unified_app.py` を追加
- `build_release.py` の更新

## マイグレーション計画

### 段階的移行

1. **Phase 1**: 統合アプリをベータ版としてリリース
   - `unified_app.py` を新規追加
   - `main.py` と `monitor_app.py` は残す

2. **Phase 2**: ユーザーフィードバック収集
   - 統合アプリの動作確認
   - UIの改善

3. **Phase 3**: 統合アプリを正式版に
   - README.mdを更新
   - 起動スクリプトを `unified_app.py` に変更
   - `main.py` と `monitor_app.py` はレガシーとしてマーク

### ユーザーへの移行案内

**README.md** に追記:
```markdown
## 統合アプリ（推奨）

全機能を1つのウィンドウで利用できる統合版です：

```bash
python src/unified_app.py
```

**レガシー版**（後方互換性のため残存）:
- ファイル処理のみ: `python src/main.py`
- フォルダ監視のみ: `python src/monitor_app.py`
```

## 技術的考慮事項

### 状態管理

- **シングルトン Engine**: TranscriptionEngineは1つだけ（メモリ節約）
- **Worker管理**: 各タブが独自のWorkerを持つが、Engine は共有
- **設定同期**: タブ間で設定を共有

### スレッドセーフティ

- UI更新は必ずメインスレッド（Qt Signal/Slot）
- Workerは別スレッド（QThread）
- FolderMonitorも別スレッド

### メモリ管理

- タブ切り替え時にWorkerをクリーンアップ
- 大量ファイル処理時のメモリリーク防止

### エラーハンドリング

- 各タブで独立したエラーハンドリング
- システムトレイ経由で通知
- ログファイルに記録

## UI/UX改善案

### タブアイコン

各タブにアイコンを表示:
- 🎤 ファイル
- 📁 フォルダ監視
- ⚙️ 設定

### ショートカットキー

- `Ctrl+1`: ファイルタブ
- `Ctrl+2`: フォルダ監視タブ
- `Ctrl+3`: 設定タブ
- `Ctrl+O`: ファイル選択
- `Ctrl+B`: バッチ処理
- `Ctrl+M`: フォルダ監視開始/停止
- `Ctrl+Q`: 終了

### ステータスバー

- 現在のデバイス（CPU/GPU）
- 処理中のファイル数
- フォルダ監視状態

### ダークモード

全タブで統一されたダークモード対応

## 成功基準

- [ ] 単一ファイル処理が動作
- [ ] バッチ処理が動作
- [ ] フォルダ監視が動作
- [ ] システムトレイが動作
- [ ] 設定が保存/復元される
- [ ] タブ切り替えがスムーズ
- [ ] メモリリークなし
- [ ] 既存テストがパス
- [ ] 新規統合テスト追加

## リスク管理

### 潜在的リスク

1. **複雑性の増加**: 統合により保守が困難になる可能性
   - 対策: タブごとにクラスを分離、明確な責任分離

2. **パフォーマンス低下**: 1つのアプリで複数機能を持つことでリソース消費増
   - 対策: 使用していない機能はメモリから解放

3. **既存ユーザーの混乱**: UIが大きく変わることへの抵抗
   - 対策: レガシー版を残す、マイグレーションガイド提供

### 回避策

- 段階的リリース（Beta → Stable）
- ユーザーフィードバックの積極的収集
- レガシー版の維持（最低6ヶ月）

## タイムライン

- **Week 1**: Task 1-3 完了（基本構造 + ファイルタブ + 監視タブ）
- **Week 2**: Task 4-6 完了（設定タブ + トレイ + 設定管理）
- **Week 3**: Task 7-8 完了（テスト + ビルド設定）
- **Week 4**: Beta リリース、フィードバック収集

## 参考資料

- PySide6 QTabWidget: https://doc.qt.io/qtforpython-6/PySide6/QtWidgets/QTabWidget.html
- QSystemTrayIcon: https://doc.qt.io/qtforpython-6/PySide6/QtWidgets/QSystemTrayIcon.html
